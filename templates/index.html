<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡∏°‡∏≠‡∏™‡πÄ‡∏ß‡∏î‡∏î‡∏¥‡πâ‡∏á CRM üìä</title>
    <style>
        :root { --messenger-blue: #0084ff; --bg-gray: #f0f2f5; --ai-gold: #fff9e6; --tag-blue: #e7f3ff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #fff; height: 100dvh; display: flex; overflow: hidden; }
        
        /* Sidebar & Inbox */
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; border-right: 1px solid #ddd; background: #fff; transition: 0.3s; z-index: 10; }
        .sidebar-header { padding: 15px; font-weight: bold; font-size: 20px; color: var(--messenger-blue); border-bottom: 1px solid #eee; text-align: center; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .contact-item:hover { background: #f5f6f7; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: #eee; object-fit: cover; flex-shrink: 0; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 15px; color: #050505; }
        .contact-msg { font-size: 13px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Inbox Tags (Blue Style) */
        .inbox-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .mini-tag { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--tag-blue); color: var(--messenger-blue); font-weight: bold; white-space: nowrap; }

        /* Chat View (Messenger Style) */
        .chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; z-index: 20; }
        .chat-view.active { transform: translateX(0); }
        .chat-header { padding: 10px 15px; border-bottom: 1px solid #eee; background: #fff; }
        .header-main { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .sync-btn { border: 1px solid #ddd; background: #fff; padding: 5px 12px; border-radius: 15px; font-size: 12px; color: #666; cursor: pointer; font-weight: 500; }
        
        /* Chat Status AI Tags */
        .ai-status-bar { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
        .status-tag { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; background: #f0f2f5; color: #606770; border: 1px solid #e4e6eb; }
        .status-tag.active { background: #e7f3ff; color: var(--messenger-blue); border-color: var(--messenger-blue); }

        .chat-container { flex: 1; padding: 15px; background: #fff; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 75%; padding: 8px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user { align-self: flex-start; background: var(--bg-gray); color: #050505; }
        .admin { align-self: flex-end; background: var(--messenger-blue); color: #fff; }

        /* AI Suggestion Area (Yellow) */
        .ai-area { background: var(--ai-gold); border-top: 1px solid #ffeeba; padding: 15px; }
        .ai-label { font-weight: bold; color: #856404; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .ai-analysis { font-size: 13px; color: #666; font-style: italic; margin-bottom: 10px; line-height: 1.4; border-bottom: 1px dashed #d1c191; padding-bottom: 10px; }
        .ai-reply { font-size: 15px; color: #333; font-weight: 500; margin-bottom: 12px; }
        .use-btn { width: 100%; background: #fff; border: 1.5px solid #856404; color: #856404; padding: 10px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .use-btn:active { background: #fdf0c2; }

        /* Footer Input */
        .footer { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; padding-bottom: env(safe-area-inset-bottom); }
        .msg-input { flex: 1; padding: 12px 18px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 15px; background: var(--bg-gray); }
        .send-btn { color: var(--messenger-blue); border: none; background: none; font-size: 28px; cursor: pointer; padding: 0; }

        @media (min-width: 768px) {
            .sidebar { width: 360px; }
            .chat-view { position: static; transform: none; display: none; width: 100%; }
            .chat-view.active { display: flex; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">‡∏°‡∏≠‡∏™‡πÄ‡∏ß‡∏î‡∏î‡∏¥‡πâ‡∏á CRM üìä</div>
        <div class="contact-list" id="contactList"></div>
    </div>

    <div class="chat-view" id="chatView">
        <div class="chat-header">
            <div class="header-main">
                <button onclick="closeChat()" style="border:none; background:none; color:var(--messenger-blue); font-size:24px; cursor:pointer;">‚ùÆ</button>
                <div id="chatTitle" style="font-weight:bold; font-size:16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢</div>
                <button onclick="syncHistoryNow()" id="syncBtn" class="sync-btn">üîÑ Sync ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="ai-status-bar" id="aiStatusBar">
                <div class="status-tag" id="typeTag">üìç ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô: -</div>
                <div class="status-tag" id="budgetTag">üí∞ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: -</div>
                <div class="status-tag" id="chanceTag">üéØ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™: -</div>
            </div>
        </div>

        <div class="chat-container" id="chatBox"></div>

        <div class="ai-area" id="aiPanel" style="display:none;">
            <div class="ai-label">ü§ñ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</div>
            <div id="aiAnalysis" class="ai-analysis">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢...</div>
            <div id="aiReply" class="ai-reply">...</div>
            <button class="use-btn" onclick="useAi()">‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå üëá</button>
        </div>

        <div class="footer">
            <input type="text" id="msgInput" class="msg-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...">
            <button class="send-btn" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <script>
        let curSid = null, aiCleanMsg = "";
        
        // Polling ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å 2-3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadContacts, 3000);
        setInterval(() => { if(curSid) loadMessages(curSid) }, 2500);

        async function loadContacts() {
            try {
                let res = await fetch('/api/contacts');
                let contacts = await res.json();
                let html = "";
                contacts.forEach(c => {
                    let pic = c.profile_pic ? c.profile_pic : 'https://via.placeholder.com/50';
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Tag ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô Inbox
                    let tagType = c.ai_tag ? `<span class="mini-tag">üìç ${c.ai_tag}</span>` : "";
                    let tagBudget = (c.ai_budget && c.ai_budget !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? `<span class="mini-tag">üí∞ ${c.ai_budget}</span>` : "";
                    let tagChance = (c.ai_chance > 0) ? `<span class="mini-tag">üéØ ${c.ai_chance}%</span>` : "";

                    html += `
                    <div class="contact-item" onclick="openChat('${c.sender_id}', '${c.first_name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}')">
                        <img src="${pic}" class="avatar" onerror="this.src='https://via.placeholder.com/50'">
                        <div class="contact-info">
                            <div class="contact-name">${c.first_name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}</div>
                            <div class="contact-msg">${c.message}</div>
                            <div class="inbox-tags">${tagType}${tagBudget}${tagChance}</div>
                        </div>
                    </div>`;
                });
                document.getElementById('contactList').innerHTML = html;
            } catch (e) { console.error("Load Contacts Error:", e); }
        }

        function openChat(sid, name) {
            curSid = sid;
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('chatView').classList.add('active');
            loadMessages(sid);
        }

        function closeChat() {
            curSid = null;
            document.getElementById('chatView').classList.remove('active');
        }

        async function loadMessages(sid) {
            try {
                let res = await fetch('/api/messages/' + sid);
                let data = await res.json();
                let html = "", latestAi = "";
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ AI ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                if(data.length > 0) {
                    let u = data[0];
                    document.getElementById('typeTag').innerText = "üìç " + (u.ai_tag || '-');
                    document.getElementById('budgetTag').innerText = "üí∞ " + (u.ai_budget || '-');
                    document.getElementById('chanceTag').innerText = "üéØ " + (u.ai_chance || '0') + "%";
                }

                data.forEach(m => {
                    if(m.sender_type === 'ai_suggestion') latestAi = m.message;
                    else if(m.message) html += `<div class="bubble ${m.sender_type}">${m.message}</div>`;
                });
                
                document.getElementById('chatBox').innerHTML = html;
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πà‡∏≠‡∏á AI Suggestion
                if(latestAi) {
                    let p = latestAi.split('###');
                    document.getElementById('aiAnalysis').innerText = p[0].trim();
                    aiCleanMsg = p[1]?.trim() || "";
                    document.getElementById('aiReply').innerText = aiCleanMsg;
                    document.getElementById('aiPanel').style.display = 'block';
                } else {
                    document.getElementById('aiPanel').style.display = 'none';
                }
            } catch (e) { console.error("Load Messages Error:", e); }
        }

        async function sendMsg() {
            let m = document.getElementById('msgInput').value.trim();
            if(!m || !curSid) return;
            document.getElementById('msgInput').value = "";
            try {
                await fetch('/api/send_reply', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body: JSON.stringify({sender_id:curSid, message:m})
                });
                loadMessages(curSid);
            } catch (e) { alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"); }
        }

        async function syncHistoryNow() {
            if(!curSid) return;
            let btn = document.getElementById('syncBtn');
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á...";
            btn.disabled = true;
            try {
                let res = await fetch('/api/sync_history/' + curSid);
                if(res.ok) {
                    alert("Sync ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    loadMessages(curSid);
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°");
                }
            } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync"); }
            btn.innerText = "üîÑ Sync ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
            btn.disabled = false;
        }

        function useAi() {
            document.getElementById('msgInput').value = aiCleanMsg;
            document.getElementById('msgInput').focus();
        }
    </script>
</body>
</html>
