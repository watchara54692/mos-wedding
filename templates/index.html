<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mos Wedding CRM V3</title>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100dvh; overflow: hidden; }
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; border-right: 1px solid #ddd; background: #fff; transition: 0.3s; }
        .contact-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #eee; object-fit: cover; }
        .tag-badge { font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #e1f5fe; color: #0288d1; margin-left: 5px; }
        
        .chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; z-index: 20; }
        .chat-view.active { transform: translateX(0); }
        .chat-header { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        
        /* Tag Bar */
        .tag-bar { padding: 8px 15px; display: flex; gap: 5px; overflow-x: auto; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .tag-btn { padding: 5px 12px; border-radius: 15px; border: 1px solid #ddd; background: #fff; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .tag-btn.active { background: #0084ff; color: #fff; border-color: #0084ff; }

        .chat-container { flex: 1; padding: 15px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 15px; }
        .user { align-self: flex-start; background: #e4e6eb; }
        .admin { align-self: flex-end; background: #0084ff; color: #fff; }

        .ai-panel { background: #fffbea; border: 1px solid #fceda4; padding: 12px; margin: 10px; border-radius: 12px; display: none; }
        .ai-analysis { font-size: 12px; color: #666; font-style: italic; border-bottom: 1px dashed #ddd; padding-bottom: 5px; margin-bottom: 5px; }
        .input-group { padding: 10px; display: flex; gap: 8px; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .input-box { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        
        @media (min-width: 768px) {
            .sidebar { width: 350px; }
            .chat-view { position: static; transform: none; width: 100%; display: none; }
            .chat-view.active { display: flex; }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">Mos CRM üìä</div>
        <div id="contactList"></div>
    </div>

    <div class="chat-view" id="chatView">
        <div class="chat-header">
            <button onclick="closeChat()" style="border:none; background:none; color:#0084ff; font-size:20px;">‚ùÆ</button>
            <div id="chatTitle" style="font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó</div>
        </div>
        
        <div class="tag-bar" id="tagBar">
            <div class="tag-btn" onclick="toggleTag('‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á')">‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
            <div class="tag-btn" onclick="toggleTag('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</div>
            <div class="tag-btn" onclick="toggleTag('‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 80%')">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 80%</div>
            <div class="tag-btn" onclick="toggleTag('‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß')">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
        </div>

        <div class="chat-container" id="chatBox"></div>

        <div class="ai-panel" id="aiPanel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:#d97706; font-size:13px;">üß† AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</span>
                <button onclick="useAi()" style="color:#0084ff; border:none; background:none; font-weight:bold; cursor:pointer;">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ üëá</button>
            </div>
            <div id="aiAnalysis" class="ai-analysis"></div>
            <div id="aiReply" style="font-weight:500;"></div>
        </div>

        <div class="input-group">
            <input type="text" id="msgInput" class="input-box" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button onclick="sendMsg()" style="background:#0084ff; color:#fff; border:none; padding:10px 20px; border-radius:20px;">‡∏™‡πà‡∏á</button>
        </div>
    </div>

    <script>
        let curSid = null, curTags = "", aiCleanMsg = "";
        setInterval(loadContacts, 3000);
        setInterval(() => { if(curSid) loadMessages(curSid) }, 2000);

        async function loadContacts() {
            let res = await fetch('/api/contacts'), contacts = await res.json(), html = "";
            contacts.forEach(c => {
                let name = c.first_name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', tags = c.tags ? c.tags.split(',').map(t => `<span class="tag-badge">${t}</span>`).join('') : "";
                html += `<div class="contact-item" onclick="openChat('${c.sender_id}', '${name}', '${c.profile_pic}', '${c.tags}')">
                    <img src="${c.profile_pic || ''}" class="avatar">
                    <div style="flex:1">
                        <div style="font-weight:bold">${name} ${tags}</div>
                        <div style="font-size:12px; color:#666">${c.message.substring(0,20)}...</div>
                    </div>
                </div>`;
            });
            document.getElementById('contactList').innerHTML = html;
        }

        function openChat(sid, name, pic, tags) {
            curSid = sid; curTags = tags || "";
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('chatView').classList.add('active');
            updateTagUI(); loadMessages(sid);
        }

        function closeChat() { curSid = null; document.getElementById('chatView').classList.remove('active'); }

        async function loadMessages(sid) {
            let res = await fetch('/api/messages/' + sid), msgs = await res.json(), html = "", latestAi = "";
            msgs.forEach(m => {
                if(m.sender_type === 'ai_suggestion') latestAi = m.message;
                else html += `<div class="bubble ${m.sender_type}">${m.message}</div>`;
            });
            document.getElementById('chatBox').innerHTML = html;
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            if(latestAi) {
                let p = latestAi.split('###');
                document.getElementById('aiAnalysis').innerText = p[0].replace('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', '').trim();
                aiCleanMsg = p.length > 1 ? p[1].trim() : latestAi;
                document.getElementById('aiReply').innerText = aiCleanMsg;
                document.getElementById('aiPanel').style.display = 'block';
            } else { document.getElementById('aiPanel').style.display = 'none'; }
        }

        function toggleTag(tag) {
            let tags = curTags.split(',').filter(t => t);
            if(tags.includes(tag)) tags = tags.filter(t => t !== tag);
            else tags.push(tag);
            curTags = tags.join(',');
            updateTagUI();
            fetch('/api/update_tags', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sender_id:curSid, tags:curTags})});
        }

        function updateTagUI() {
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.toggle('active', curTags.split(',').includes(btn.innerText));
            });
        }

        function useAi() { document.getElementById('msgInput').value = aiCleanMsg; document.getElementById('msgInput').focus(); }
        async function sendMsg() {
            let m = document.getElementById('msgInput').value; if(!m) return;
            document.getElementById('msgInput').value = "";
            await fetch('/api/send_reply', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sender_id:curSid, message:m})});
            loadMessages(curSid);
        }
    </script>
</body>
</html>
