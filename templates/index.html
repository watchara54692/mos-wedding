<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mos Inbox</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; background: #fff; height: 100dvh; overflow: hidden; display: flex; }
        
        /* --- Sidebar: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --- */
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; background: #fff; z-index: 10; transition: transform 0.3s ease; border-right: 1px solid #ddd; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; background: #f8f9fa; font-size: 18px; text-align: center; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .contact-item:active { background: #f0f2f5; }
        .contact-avatar { width: 40px; height: 40px; background: #e4e6eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 15px; margin-bottom: 3px; }
        .contact-last-msg { font-size: 13px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-dot { width: 10px; height: 10px; background: #0084ff; border-radius: 50%; display: none; }
        .contact-item.has-unread .unread-dot { display: block; }

        /* --- Chat View: ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó --- */
        .chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
        .chat-view.active { transform: translateX(0); } /* ‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ */

        .chat-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .back-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #0084ff; padding: 0 5px; }
        .chat-title { font-weight: bold; font-size: 16px; flex: 1; }

        .chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user { align-self: flex-start; background: #e4e6eb; color: #000; border-bottom-left-radius: 4px; }
        .admin { align-self: flex-end; background: #0084ff; color: #fff; border-bottom-right-radius: 4px; }
        .ai-suggestion-bubble { align-self: center; background: #fff9c4; border: 1px dashed #fbc02d; font-size: 13px; color: #555; padding: 8px 12px; border-radius: 10px; width: 90%; cursor: pointer; text-align: center; }

        /* --- Footer (AI + Input) --- */
        .chat-footer { padding: 10px; background: #fff; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom, 10px); }
        
        .ai-panel { background: #fffbea; border: 1px solid #fceda4; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: none; font-size: 14px; max-height: 150px; overflow-y: auto; }
        .ai-label { font-weight: bold; color: #d97706; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .use-ai-btn { background: #fff; border: 1px solid #d97706; color: #d97706; font-size: 12px; border-radius: 12px; padding: 2px 8px; }

        .input-group { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; max-height: 100px; resize: none; overflow-y: auto; background: #f9fafb; }
        .send-btn { background: #0084ff; color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,132,255,0.3); }

        /* Desktop Mode */
        @media (min-width: 768px) {
            .sidebar { width: 350px; border-right: 1px solid #ddd; }
            .chat-view { position: static; transform: none; width: 100%; display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
            .chat-view.active { display: flex; }
            .back-btn { display: none; } /* Desktop ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Back */
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">Mos Inbox üí¨</div>
        <div class="contact-list" id="contactList">
            <div style="text-align:center; color:#999; margin-top:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <div class="chat-view" id="chatView">
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()">‚ùÆ</button>
            <div class="chat-title" id="chatTitle">Chat Room</div>
        </div>
        
        <div class="chat-container" id="chatBox"></div>

        <div class="chat-footer">
            <div class="ai-panel" id="aiPanel">
                <div class="ai-label">
                    <span>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</span>
                    <button class="use-ai-btn" onclick="applyAiSuggestion()">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ üëá</button>
                </div>
                <div id="aiAnalysisText" style="color:#666; font-size:12px; margin-bottom:5px;"></div>
                <div id="aiReplyText" style="color:#000; font-weight:500;"></div>
            </div>

            <div class="input-group">
                <textarea id="msgInput" class="chat-input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea>
                <button class="send-btn" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let currentSenderId = null;
        let aiCleanReply = "";

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadContacts, 3000);
        loadContacts();

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà)
        setInterval(() => {
            if (currentSenderId) loadMessages(currentSenderId);
        }, 2000);

        async function loadContacts() {
            try {
                let res = await fetch('/api/contacts');
                let contacts = await res.json();
                let html = "";
                
                contacts.forEach(c => {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô list
                    let snippet = c.message.substring(0, 30) + (c.message.length > 30 ? "..." : "");
                    if (c.sender_type === 'ai_suggestion') snippet = "ü§ñ (AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)";
                    
                    html += `
                    <div class="contact-item" onclick="openChat('${c.sender_id}')">
                        <div class="contact-avatar">üë§</div>
                        <div class="contact-info">
                            <div class="contact-name">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ID: ${c.sender_id.substring(0,8)}...</div>
                            <div class="contact-last-msg">${snippet}</div>
                        </div>
                    </div>`;
                });
                document.getElementById('contactList').innerHTML = html;
            } catch (e) { console.log(e); }
        }

        async function openChat(senderId) {
            currentSenderId = senderId;
            document.getElementById('chatTitle').innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: " + senderId;
            document.getElementById('chatView').classList.add('active'); // ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
            loadMessages(senderId); // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }

        function closeChat() {
            currentSenderId = null;
            document.getElementById('chatView').classList.remove('active'); // ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡∏≠‡∏≠‡∏Å
        }

        async function loadMessages(senderId) {
            try {
                let res = await fetch('/api/messages/' + senderId);
                let msgs = await res.json();
                let html = "";
                let latestAi = null;

                msgs.forEach(m => {
                    if (m.sender_type === 'user') {
                        html += `<div class="bubble user">${m.message}</div>`;
                    } else if (m.sender_type === 'admin') {
                        html += `<div class="bubble admin">${m.message}</div>`;
                    } else if (m.sender_type === 'ai_suggestion') {
                        latestAi = m.message; // ‡πÄ‡∏Å‡πá‡∏ö AI ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ
                    }
                });

                let chatBox = document.getElementById('chatBox');
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å)
                if (chatBox.getAttribute('data-last-count') != msgs.length) {
                    chatBox.innerHTML = html;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    chatBox.setAttribute('data-last-count', msgs.length);
                }

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AI
                if (latestAi) {
                    let parts = latestAi.split('###');
                    let analysis = parts.length > 1 ? parts[0].replace('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', '').trim() : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå";
                    let reply = parts.length > 1 ? parts.slice(1).join(' ').trim() : latestAi;
                    
                    aiCleanReply = reply;
                    document.getElementById('aiAnalysisText').innerText = analysis;
                    document.getElementById('aiReplyText').innerText = reply;
                    document.getElementById('aiPanel').style.display = 'block';
                } else {
                    document.getElementById('aiPanel').style.display = 'none';
                }

            } catch (e) { console.log(e); }
        }

        function applyAiSuggestion() {
            document.getElementById('msgInput').value = aiCleanReply;
            document.getElementById('msgInput').focus();
        }

        async function sendMsg() {
            let txt = document.getElementById('msgInput').value.trim();
            if (!txt || !currentSenderId) return;

            document.getElementById('msgInput').value = "";
            document.getElementById('aiPanel').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô AI ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á

            await fetch('/api/send_reply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender_id: currentSenderId, message: txt })
            });
            loadMessages(currentSenderId);
        }
        
        // Auto resize textarea
        document.getElementById('msgInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
</html>
