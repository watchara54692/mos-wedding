<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mos Inbox V2</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: #fff; height: 100dvh; overflow: hidden; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; background: #fff; border-right: 1px solid #ddd; z-index: 10; }
        .sidebar-header { padding: 15px; font-weight: bold; background: #f8f9fa; border-bottom: 1px solid #eee; text-align: center; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; gap: 12px; align-items: center; }
        .contact-item:active { background: #f0f2f5; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #1c1e21; }
        .contact-msg { font-size: 13px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Chat View */
        .chat-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
        .chat-view.active { transform: translateX(0); }

        .chat-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .back-btn { border: none; background: none; font-size: 24px; color: #0084ff; padding: 0; cursor: pointer; }
        .chat-title-group { display: flex; align-items: center; gap: 10px; }
        .chat-title-name { font-weight: bold; font-size: 16px; }

        .chat-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .user { align-self: flex-start; background: #e4e6eb; color: #000; border-bottom-left-radius: 4px; }
        .admin { align-self: flex-end; background: #0084ff; color: #fff; border-bottom-right-radius: 4px; }

        /* AI Panel (‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) */
        .chat-footer { padding: 10px; background: #fff; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom, 10px); }
        .ai-panel { 
            background: #fffbea; border: 1px solid #fceda4; border-radius: 12px; 
            padding: 12px; margin-bottom: 10px; display: none; font-size: 14px; 
            max-height: 200px; overflow-y: auto; 
        }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ai-label { font-weight: bold; color: #d97706; font-size: 13px; }
        .use-ai-btn { background: #fff; border: 1px solid #d97706; color: #d97706; border-radius: 12px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: bold; }
        
        .ai-analysis { color: #666; font-style: italic; font-size: 13px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #e6c84c; }
        .ai-reply { color: #000; font-weight: 500; }

        .input-group { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; max-height: 100px; resize: none; overflow-y: auto; background: #f9fafb; }
        .send-btn { background: #0084ff; color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        @media (min-width: 768px) {
            .sidebar { width: 350px; }
            .chat-view { position: static; transform: none; width: 100%; display: none; }
            .chat-view.active { display: flex; }
            .back-btn { display: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">Mos Inbox üí¨</div>
        <div class="contact-list" id="contactList">
            <div style="text-align:center; color:#999; margin-top:20px;">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>
        </div>
    </div>

    <div class="chat-view" id="chatView">
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()">‚ùÆ</button>
            <div class="chat-title-group">
                <img id="headerAvatar" class="avatar" style="width:35px; height:35px; display:none;">
                <div class="chat-title-name" id="chatTitle">Chat</div>
            </div>
        </div>
        
        <div class="chat-container" id="chatBox"></div>

        <div class="chat-footer">
            <div class="ai-panel" id="aiPanel">
                <div class="ai-header">
                    <span class="ai-label">üß† AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå & ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span>
                    <button class="use-ai-btn" onclick="applyAiSuggestion()">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ üëá</button>
                </div>
                <div id="aiAnalysisText" class="ai-analysis"></div>
                <div id="aiReplyText" class="ai-reply"></div>
            </div>

            <div class="input-group">
                <textarea id="msgInput" class="chat-input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea>
                <button class="send-btn" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let currentSenderId = null;
        let aiCleanReply = "";

        // Auto Refresh
        setInterval(loadContacts, 3000);
        setInterval(() => { if (currentSenderId) loadMessages(currentSenderId); }, 2000);
        loadContacts();

        async function loadContacts() {
            try {
                let res = await fetch('/api/contacts');
                let contacts = await res.json();
                let html = "";
                
                contacts.forEach(c => {
                    let displayName = (c.first_name && c.first_name !== 'None') 
                                      ? `${c.first_name} ${c.last_name || ''}` 
                                      : `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${c.sender_id.substring(0,6)}`;
                    
                    let avatarSrc = (c.profile_pic && c.profile_pic !== 'None') 
                                    ? c.profile_pic 
                                    : 'https://cdn-icons-png.flaticon.com/512/847/847969.png'; // ‡∏£‡∏π‡∏õ Default

                    let snippet = c.message.substring(0, 25) + "...";
                    if (c.sender_type === 'ai_suggestion') snippet = "üí° AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...";

                    html += `
                    <div class="contact-item" onclick="openChat('${c.sender_id}', '${displayName}', '${avatarSrc}')">
                        <img src="${avatarSrc}" class="avatar">
                        <div class="contact-info">
                            <div class="contact-name">${displayName}</div>
                            <div class="contact-msg">${snippet}</div>
                        </div>
                    </div>`;
                });
                document.getElementById('contactList').innerHTML = html;
            } catch (e) { console.log(e); }
        }

        async function openChat(senderId, name, avatar) {
            currentSenderId = senderId;
            document.getElementById('chatTitle').innerText = name;
            
            let img = document.getElementById('headerAvatar');
            img.src = avatar;
            img.style.display = 'block';

            document.getElementById('chatView').classList.add('active');
            loadMessages(senderId);
        }

        function closeChat() {
            currentSenderId = null;
            document.getElementById('chatView').classList.remove('active');
        }

        async function loadMessages(senderId) {
            try {
                let res = await fetch('/api/messages/' + senderId);
                let msgs = await res.json();
                let html = "";
                let latestAi = null;

                msgs.forEach(m => {
                    if (m.sender_type === 'user') {
                        html += `<div class="bubble user">${m.message}</div>`;
                    } else if (m.sender_type === 'admin') {
                        html += `<div class="bubble admin">${m.message}</div>`;
                    } else if (m.sender_type === 'ai_suggestion') {
                        latestAi = m.message;
                    }
                });

                let chatBox = document.getElementById('chatBox');
                if (chatBox.getAttribute('data-count') != msgs.length) {
                    chatBox.innerHTML = html;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    chatBox.setAttribute('data-count', msgs.length);
                }

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI
                if (latestAi) {
                    let parts = latestAi.split('###');
                    let analysis = "";
                    let reply = "";

                    if (parts.length > 1) {
                        analysis = parts[0].replace('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:', '').trim();
                        reply = parts.slice(1).join(' ').trim();
                    } else {
                        // ‡∏ñ‡πâ‡∏≤ AI ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà ###
                        analysis = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå";
                        reply = latestAi;
                    }

                    aiCleanReply = reply;
                    document.getElementById('aiAnalysisText').innerText = "üí° " + analysis;
                    document.getElementById('aiReplyText').innerText = reply;
                    document.getElementById('aiPanel').style.display = 'block';
                } else {
                    document.getElementById('aiPanel').style.display = 'none';
                }

            } catch (e) { console.log(e); }
        }

        function applyAiSuggestion() {
            document.getElementById('msgInput').value = aiCleanReply;
            document.getElementById('msgInput').focus();
            autoResize(document.getElementById('msgInput'));
        }

        async function sendMsg() {
            let txt = document.getElementById('msgInput').value.trim();
            if (!txt || !currentSenderId) return;

            document.getElementById('msgInput').value = "";
            document.getElementById('aiPanel').style.display = 'none'; 

            await fetch('/api/send_reply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender_id: currentSenderId, message: txt })
            });
            loadMessages(currentSenderId);
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }
        document.getElementById('msgInput').addEventListener('input', function(){ autoResize(this) });

    </script>
</body>
</html>
